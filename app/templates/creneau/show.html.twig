{% extends 'base.html.twig' %}

{% block title %}Réservation - {{ pattern.title }}{% endblock %}

{% block body %}
    <twig:WikiCard title="Réservation de créneau" backUrl="{{ path('app_wiki_show', {id: wiki.id}) }}">
        {% block content %}
            <div class="space-y-6">
                {# Informations sur le wiki #}
                <div class="border-b pb-4">
                    <h2 class="text-lg font-semibold text-gray-800 mb-2">Page Wiki</h2>
                    <a href="{{ path('app_wiki_show', {id: wiki.id}) }}" class="text-blue-600 hover:underline">
                        {{ wiki.title }}
                    </a>
                </div>

                {# Informations sur le créneau #}
                <div class="border-b pb-4">
                    <h2 class="text-lg font-semibold text-gray-800 mb-2">Détails du créneau</h2>
                    <div class="space-y-2">
                        <div>
                            <span class="font-medium">Titre :</span>
                            <span class="ml-2">{{ pattern.title }}</span>
                        </div>
                        <div>
                            <span class="font-medium">Date et heure :</span>
                            <span class="ml-2">
                                {{ occurrenceStart|date('d/m/Y à H:i') }} → {{ occurrenceEnd|date('H:i') }}
                            </span>
                        </div>
                        <div>
                            <span class="font-medium">Jour de la semaine :</span>
                            <span class="ml-2">
                                {% set d = pattern.dayOfWeek %}
                                {% if d == 1 %}Lundi{% elseif d == 2 %}Mardi{% elseif d == 3 %}Mercredi{% elseif d == 4 %}Jeudi{% elseif d == 5 %}Vendredi{% elseif d == 6 %}Samedi{% else %}Dimanche{% endif %}
                            </span>
                        </div>
                        <div>
                            <span class="font-medium">Capacité :</span>
                            <span class="ml-2">{{ capacity }} place{{ capacity > 1 ? 's' : '' }}</span>
                        </div>
                        <div>
                            <span class="font-medium">Places disponibles :</span>
                            <span class="ml-2 {% if isAvailable %}text-green-600 font-semibold{% else %}text-red-600 font-semibold{% endif %}">
                                {{ remainingSlots }} place{{ remainingSlots > 1 ? 's' : '' }}
                            </span>
                        </div>
                    </div>
                </div>

                {# Liste des utilisateurs qui ont réservé #}
                {% if existingReservations is not empty %}
                    <div class="border-b pb-4">
                        <h2 class="text-lg font-semibold text-gray-800 mb-3">Réservations ({{ existingCount }}/{{ capacity }})</h2>
                        <div class="space-y-2">
                            {% for reservation in existingReservations %}
                                <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                    <div class="text-sm">
                                        {% if reservation.user %}
                                            <span class="font-medium text-gray-800">
                                                {{ reservation.user.pseudo ?: reservation.user.email }}
                                            </span>
                                        {% else %}
                                            <span class="text-gray-500 italic">Utilisateur supprimé</span>
                                        {% endif %}
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        Réservé le {{ reservation.start|date('d/m/Y à H:i') }}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}

                {# Formulaire de réservation #}
                {% if app.user %}
                    {% if isAvailable %}
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h3 class="text-lg font-semibold text-green-800 mb-3">Réserver ce créneau</h3>
                            <p class="text-sm text-green-700 mb-4">
                                Vous êtes sur le point de réserver ce créneau. Cliquez sur le bouton ci-dessous pour confirmer.
                            </p>
                            <form method="post" action="{{ path('app_creneau_show', {
                                wikiId: wiki.id,
                                patternId: pattern.id,
                                start: occurrenceStart|date('Y-m-d\\TH:i:s')
                            }) }}">
                                <input type="hidden" name="_token" value="{{ csrf_token('reserve_creneau' ~ pattern.id ~ occurrenceStart|date('Y-m-d\\TH:i:s')) }}">
                                <button type="submit" class="px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 font-semibold transition">
                                    Confirmer la réservation
                                </button>
                            </form>
                        </div>
                    {% else %}
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <h3 class="text-lg font-semibold text-red-800 mb-2">Créneau complet</h3>
                            <p class="text-sm text-red-700">
                                Ce créneau est déjà complet ({{ existingCount }}/{{ capacity }} réservations). 
                                Veuillez choisir un autre créneau.
                            </p>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-blue-800 mb-2">Connexion requise</h3>
                        <p class="text-sm text-blue-700 mb-3">
                            Vous devez être connecté pour réserver un créneau.
                        </p>
                        <a href="{{ path('app_login') }}" class="inline-block px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-semibold">
                            Se connecter
                        </a>
                    </div>
                {% endif %}
            </div>
        {% endblock %}
    </twig:WikiCard>
{% endblock %}

